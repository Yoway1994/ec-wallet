## 用戶故事
作為 電商支付系統的管理者，
我想要 有一個高效的錢包服務，能夠管理和重用加密貨幣地址，
以便 系統能夠快速分配支付地址，確保地址有效管理和可重複使用，優化資源利用。

作為 錢包服務的開發者，
我想要 優化錢包服務的內部實現，使其高效管理地址資源，
以便 在高並發場景下仍能提供穩定可靠的地址分配服務。

## 描述
在既有的錢包服務（Wallet Service）內部實現一個高效的地址池管理機制，作為錢包服務的核心基礎設施。該地址池負責創建、分配、回收和監控加密貨幣地址資源，但不直接暴露給應用層或業務層，而是通過錢包服務的領域接口（如 `AcquireAddress`、`ReleaseAddress`）間接使用。

地址池機制需要支持多種加密貨幣（如 BNB、ETH 等），並提供高效的並發訪問能力。實現上將通過數據庫持久化地址狀態，同時使用內存緩存提高響應速度。

作為錢包服務的內部實現，地址池需要支持以下核心功能：
1. 地址生命週期管理：預生成、分配、預留、使用、釋放
2. 支持通過錢包服務接口傳遞的選項參數，如訂單ID、客戶ID、過期時間等
3. 自動處理過期預留的地址
4. 提供內部監控和自動擴容機制

### 地址狀態轉換說明

在電商支付場景下，地址池中的地址有以下生命週期狀態：

#### 1. **AVAILABLE（可用）**
這是地址的初始狀態或回收後的狀態：
- 地址已經生成並加入池中，但尚未分配給任何訂單或用戶
- 之前使用過的地址已經完成其任務（收款已處理完畢）並重新回到地址池
- 系統可以立即將其分配給新的訂單

**電商場景**：當系統需要為新訂單分配支付地址時，會從AVAILABLE狀態的地址中選取。

#### 2. **RESERVED（預留）**
這表示地址已經被臨時分配，但交易尚未確認：
- 用戶創建訂單，系統為此訂單分配了支付地址
- 地址已與特定訂單關聯，但用戶尚未完成支付
- 有時間限制（通常15-30分鐘），超時後如果沒有收到支付，地址會回到AVAILABLE

**電商場景**：用戶在結帳頁面看到了支付指引，系統顯示「請在3×分鐘內向此地址支付XX BNB」，但用戶尚未實際發送資金。

#### 3. **USED（已用）**
這表示地址已實際使用且交易正在處理中：
- 系統檢測到此地址已收到用戶支付的資金
- 訂單處理流程正在進行（等待區塊確認、處理訂單商品等）
- 在支付處理完全結束前，此地址不能分配給其他訂單

**電商場景**：用戶已經向地址發送了加密貨幣，系統正在處理收款，訂單狀態可能變為「支付中」或「處理中」。

#### 4. **從 USED 返回 AVAILABLE 的時機**
完成以下步驟後，地址可以回到可用狀態：
- 系統已確認收到的資金（足夠的區塊確認數）
- 相關訂單已處理完成並更新狀態（如「已完成」或「已發貨」）
- 可能會有一個短暫的冷卻期，確保交易完全結束
- 資金已從該地址轉出到商家的主錢包或處理完畢

#### 5. **完整流程示例**

1. 小明在電商平台選購商品→結帳→選擇BNB支付
2. 系統從地址池獲取一個**AVAILABLE**的地址A，轉為**RESERVED**狀態，並關聯到訂單#12345
3. 小明看到支付頁面顯示「請在30分鐘內支付0.5 BNB到地址A」
4. 小明完成支付→系統檢測到地址A收到款項→地址狀態從**RESERVED**變為**USED**
5. 系統確認支付→處理訂單→完成發貨流程
6. 系統將收到的資金從地址A轉移到商家的集中錢包
7. 交易完成一段時間後→系統將地址A狀態從**USED**恢復為**AVAILABLE**，可用於新訂單

## 開發任務
- [ ] 設計錢包服務內部地址池的實現
  - [ ] 在基礎設施層定義地址池結構和內部方法
  - [ ] 使用DDD原則設計地址生命週期和狀態轉換
  - [ ] 確保與領域層的 `Wallet` 接口設計一致

- [ ] 實現數據庫持久化層
  - [ ] 創建地址表結構設計
  - [ ] 實現基本的CRUD操作
  - [ ] 添加并發控制和事務支持

- [ ] 實現內存緩存層
  - [ ] 設計緩存結構和更新策略
  - [ ] 確保緩存與數據庫的一致性
  - [ ] 實現線程安全的地址分配機制

- [ ] 增強錢包服務實現
  - [ ] 實現地址池預熱和初始化邏輯
  - [ ] 優化 `walletService.AcquireAddress` 方法使用地址池
  - [ ] 實現 `walletService.ReleaseAddress` 方法歸還地址到池中
  - [ ] 添加地址使用確認和狀態變更功能
  - [ ] 實現清理過期預留地址的後台任務

- [ ] 集成與測試
  - [ ] 集成到現有的錢包服務中
  - [ ] 編寫單元測試和集成測試
  - [ ] 性能測試和並發測試

## 驗收標準
- [ ] 錢包服務能夠預生成指定數量的加密貨幣地址並高效管理
- [ ] 錢包服務能在高並發情況下高效地分配地址，保持一致性
- [ ] 地址預留有明確的過期時間，超時後自動釋放並可重複使用
- [ ] 錢包服務提供以下功能：
  - 獲取可用地址統計信息（通過適當的日誌或管理接口）
  - 釋放特定預留地址
- [ ] 在大量並發請求下（每秒100+請求），`AcquireAddress` 方法響應時間不超過100ms
- [ ] 完整的單元測試和集成測試覆蓋率超過80%
- [ ] 提供錢包服務的內部技術文檔，包括地址管理的設計原理和關鍵流程

## 相關 Epic
[epic-001-地址生成與收款](../../epics/epic-001-地址生成與收款.md)